# Start

# Thesis title: The Role of International Commitments in Combating the Illicit Distribution of Cocaine.
# Author: Raquel Baeta

# Data Source: United Nations (UN)
# Variables: Convention on Psychotropic Substances [1971], Single Convention on Narcotic Drugs [1961], and United Nations Convention 
# against illicit traffic in Narcotic Drugs and Psychotropic Substances [1988].

# Install Required Packages
install.packages("readxl") 
install.packages("dplyr") 
install.packages("countrycode") 

# Load Libraries
library(readxl) # work with Excel files
library(dplyr) # data manipulation
library(countrycode) # country code conversions

# [1] Clean data set 

# Step 1.1: Read the Excel file "un_treaty.xlsx" into a data frame named untreaties.
untreaties <- read_excel("un_treaty.xlsx")
head(untreaties) # preview the first few rows

# Step 1.2: Filter out rows corresponding to countries "United States of America" and "United Kingdom" as these countries were dropped 
# from the analysis.
untreaties <- untreaties %>%
  filter(country != "United States of America", country != "United Kingdom")

# Step 1.3: Convert the treaty values in columns un1971, un1961, and un1988 to numeric values ("0" for no commitment or "1" for 
# commitment) using the ifelse function.
untreaties$un1971 <- ifelse(untreaties$un1971 > 0, 1, 0)
untreaties$un1961 <- ifelse(untreaties$un1961 > 0, 1, 0)
untreaties$un1988 <- ifelse(untreaties$un1988 > 0, 1, 0)

# Step 1.4: Replace any missing values in the treaty columns with 0.
untreaties$un1971[is.na(untreaties$un1971)] <- 0
untreaties$un1961[is.na(untreaties$un1961)] <- 0
untreaties$un1988[is.na(untreaties$un1988)] <- 0

# Step 1.5: Add new columns code and region to the data frame. The code column contains ISO 3-letter country codes, and the region 
# column contains continent names.
untreaties$code <- countrycode(untreaties$country, 
                               origin = "country.name", 
                               destination = "iso3c")

untreaties$region <- countrycode(untreaties$code, 
                                 origin = "iso3c", 
                                 destination = "continent")

# Step 1.6: Export the cleaned data frame untreaties to a CSV file named "untreaties.csv".
fwrite(untreaties, "untreaties.csv")

# Descriptive Statistics 

# [2] Overall Commitment across States and United Nations Treaties.

# Step 2.1: Summarise commitment status per country for each United Nations Treaty
summarised_data <- complete_data %>%
  group_by(country) %>%
  summarize(un1961 = max(un1961), 
            un1971 = max(un1971), 
            un1988 = max(un1988))

# Step 2.2: Reshape data for plotting
reshaped_data <- summarised_data %>%
  pivot_longer(cols = c(un1961, un1971, un1988), names_to = "Treaty", values_to = "Commitment")

# Step 2.3: Create a bar plot for state commitment
overall_un_plot <- ggplot(reshaped_data, aes(x = Treaty, fill = factor(Commitment))) +
  geom_bar(stat = "count") +
  labs(title = "State Commitment to United Nations Treaties", x = "United Nations Treaty", y = "State Commitment (Count)",
       caption = "Source: United Nations (UN)") +
  scale_fill_manual(values = c("0" = "orange", "1" = "navy blue"), labels = c("0" = "No Commitment", "1" = "Commitment"),
                    name = "Commitment") +
  theme(panel.border = element_blank(), axis.text.x = element_text(angle = 0, hjust = 0.5))

# Step 2.4: Print and save the combined table and display the bar plot
print(overall_un_plot)
ggsave(filename = "overall_un_plot.png", plot = overall_un_plot)

# Step 2.5: Create a table for commitment using stargazer
country_un_table <- stargazer(summarised_data,
                              title = "State Commitment to United Nations Treaties",
                              type = "text", # Display as plain text
                              column.labels = c("Country", "UN1961", "UN1971", "UN1988"),
                              summary = FALSE)

# Step 2.6: Calculate summary statistics for different years
un_stats <- summarised_data %>%
  summarize(mean_un1961 = mean(un1961), median_un1961 = median(un1961), sd_un1961 = sd(un1961),
            mean_un1971 = mean(un1971), median_un1971 = median(un1971), sd_un1971 = sd(un1971),
            mean_un1988 = mean(un1988), median_un1988 = median(un1988), sd_un1988 = sd(un1988))

# Step 2.7: Convert the summary_stats matrix to a data frame
un_stats <- as.data.frame(un_stats)

# Step 2.8: Display summary statistics for "un_stats" in a table
un_stats_table <- stargazer(un_stats,
                            title = "Summary Statistics: United Nations Treaties",
                            type = "text",  # Display as plain text
                            flip = TRUE,
                            summary = FALSE,
                            row.labels = c("Mean (1961)", "Median (1961)", "Standard Deviation (1961)",
                                           "Mean (1971)", "Median (1971)", "Standard Deviation (1971)",
                                           "Mean (1988)", "Median (1988)", "Standard Deviation (1988)"),
                            column.sep.width = "1pt")  # Set width of column separator

# Step 2.9: Save the table as a text file
write.table(un_stats_table, file = "un_stats_table.txt", sep = "\t")

# Step 2.10: Clean environment
rm(summarised_data, reshaped_data, overall_un_plot, country_un_table, un_stats, un_stats_table) 

# [3] Commitment across states and each United Nations Treaties.

# [3.1] United Nations Treaty, 1961.

# Step 3.1.1: Filter data for the United Nations 1961 treaty only
un1961_data <- subset(complete_data, select = c("country", "un1961"))

# Step 3.1.2: Summarise commitment status per country for the 1961 Treaty
summarised_un1961 <- complete_data %>%
  group_by(country) %>%
  summarize(un1961 = max(un1961))
            
# Step 3.1.3: Create a bar plot for the United Nations 1961 treaty commitment breakdown by state
un1961_plot <- ggplot(summarised_un1961, aes(x = country, fill = factor(un1961))) +
  geom_bar(stat = "count") +
  labs(title = "State commitment to United Nations Single Convention on Narcotic Drugs, 1961", x = "State", 
       y = "Commitment (Count)", caption = "Source: United Nations (UN)") +
  scale_fill_manual(values = c("0" = "orange", "1" = "navy blue"), labels = c("0" = "No Commitment", "1" = "Commitment"),
                    name = "Commitment") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Step 3.1.4: Print and save the combined table and display the bar plot
print(un1961_plot)
ggsave(filename = "un1961_plot.png", plot = un1961_plot)

# [2.2] United Nations Treaty, 1971.

# Step 3.2.1: Filter data for United Nations 1971 treaty only
un1971_data <- subset(complete_data, select = c("country", "un1971"))

# Step 3.2.2: Summarise commitment status per country for 1971 Treaty
summarised_un1971 <- complete_data %>%
  group_by(country) %>%
  summarize(un1971 = max(un1971))

# Step 3.2.3: Create bar plot for United Nations 1971 treaty commitment 
# breakdown by state
un1971_plot <- ggplot(summarised_un1971, aes(x = country, fill = factor(un1971))) +
  geom_bar(stat = "count") +
  labs(title = "State commitment to United Nations Convention on Psychotropic Substances, 1971", x = "State",
       y = "Commitment (Count)", caption = "Source: United Nations (UN)") +
  scale_fill_manual(values = c("0" = "orange", "1" = "navy blue"), labels = c("0" = "No Commitment", "1" = "Commitment"),
                    name = "Commitment") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Step 3.2.4: Print and save the combined table and display the bar plot
print(un1971_plot)
ggsave(filename = "un1971_plot.png", plot = un1971_plot)

# [3.3] United Nations Treaty, 1988.

# Step 3.3.1: Filter data for United Nations 1988 treaty only
un1988_data <- subset(complete_data, select = c("country", "un1988"))

# Step 3.3.2: Summarise commitment status per country for 1961 Treaty
summarised_un1988 <- complete_data %>%
  group_by(country) %>%
  summarize(un1988 = max(un1988))

# Step 3.3.3: Create bar plot for United Nations 1988 treaty commitment 
# breakdown by state
un1988_plot <- ggplot(summarised_un1988, aes(x = country, fill = factor(un1988))) +
  geom_bar(stat = "count") +
  labs(
    title = "State commitment to United Nations Convention against illicit traffic in Narcotic Drugs and Psychotropic Substances, 1988",
    x = "State", y = "Commitment (Count)", caption = "Source: United Nations (UN)") +
  scale_fill_manual(values = c("0" = "orange", "1" = "navy blue"), labels = c("0" = "No Commitment", "1" = "Commitment"), 
                    name = "Commitment") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) # Adjust margin to remove indent

# Step 3.3.4: Print and save the combined table and display the bar plot
print(un1988_plot)
ggsave(filename = "un1988_plot.png", plot = un1988_plot)

# [4] grid.arrange() all United Nations plots 

# Step 4.1: Display and save all three plots together
plot_grid_commitment <- grid.arrange(un1961_plot, un1971_plot, un1988_plot, 
                                     ncol = 1,
                                     top = textGrob("Bar Plot Series: State Commitment Over United Nations Treaties",
                                                    gp = gpar(fontsize = 16, margin = margin(b = 20))))

# Step 4.2: Save the plot
ggsave(filename = "plot_grid_commitment.png", plot = plot_grid_commitment)

# Step 4.3: Clean environment
rm(un1961_data, summarised_un1961, un1961_plot, un1971_data, summarised_un1971,
   un1971_plot, un1988_data, summarised_un1988, un1988_plot, plot_grid_commitment)

# End
